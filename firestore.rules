rules_version = '2';
// Deploy with: firebase deploy --only firestore
// Or paste into Firebase Console → Firestore Database → Rules
service cloud.firestore {
  match /databases/{database}/documents {
    // Users: any authenticated user can read (for org/team member display); only owner can write
    match /users/{userId} {
      allow read: if request.auth != null;
      allow write: if request.auth != null && request.auth.uid == userId;
      match /todos/{todoId} {
        allow read, write: if request.auth != null && request.auth.uid == userId;
      }
      match /importedCalendarEvents/{eventId} {
        allow read, write: if request.auth != null && request.auth.uid == userId;
      }
      match /blocked/{blockedUserId} {
        allow read, write: if request.auth != null && request.auth.uid == userId;
      }
      match /starred/{starredId} {
        allow read, write: if request.auth != null && request.auth.uid == userId;
      }
      match /favorites/{favoriteId} {
        allow read, write: if request.auth != null && request.auth.uid == userId;
      }
    }

    // Organizations: authenticated users can create (new org) and read (search, get)
    match /organizations/{orgId} {
      allow create, read: if request.auth != null;
      allow update, delete: if request.auth != null;

      // Teams: active org members only
      match /teams/{teamId} {
        allow read, create, update: if request.auth != null
          && exists(/databases/$(database)/documents/memberships/$(orgId + '_' + request.auth.uid))
          && get(/databases/$(database)/documents/memberships/$(orgId + '_' + request.auth.uid)).data.state == 'active';
      }

      // Team memberships: active org members
      match /teamMemberships/{tmId} {
        allow read, create, update: if request.auth != null
          && exists(/databases/$(database)/documents/memberships/$(orgId + '_' + request.auth.uid))
          && get(/databases/$(database)/documents/memberships/$(orgId + '_' + request.auth.uid)).data.state == 'active';
      }

      // Meetings: active org members
      match /meetings/{meetingId} {
        allow read, create, update: if request.auth != null
          && exists(/databases/$(database)/documents/memberships/$(orgId + '_' + request.auth.uid))
          && get(/databases/$(database)/documents/memberships/$(orgId + '_' + request.auth.uid)).data.state == 'active';
      }

      // Conversations (WhatsApp-style: DM, group, team chats)
      match /conversations/{convId} {
        allow read: if request.auth != null
          && request.auth.uid in resource.data.members
          && exists(/databases/$(database)/documents/memberships/$(orgId + '_' + request.auth.uid))
          && get(/databases/$(database)/documents/memberships/$(orgId + '_' + request.auth.uid)).data.state == 'active';
        allow create: if request.auth != null
          && request.auth.uid in request.resource.data.members
          && request.resource.data.members is list
          && request.resource.data.type is string
          && exists(/databases/$(database)/documents/memberships/$(orgId + '_' + request.auth.uid))
          && get(/databases/$(database)/documents/memberships/$(orgId + '_' + request.auth.uid)).data.state == 'active';
        allow update: if request.auth != null && request.auth.uid in resource.data.members;
        allow delete: if false;
        match /messages/{messageId} {
          allow read, create: if request.auth != null
            && exists(/databases/$(database)/documents/memberships/$(orgId + '_' + request.auth.uid))
            && get(/databases/$(database)/documents/memberships/$(orgId + '_' + request.auth.uid)).data.state == 'active'
            && request.auth.uid in get(/databases/$(database)/documents/organizations/$(orgId)/conversations/$(convId)).data.members;
          allow update: if request.auth != null
            && request.auth.uid in get(/databases/$(database)/documents/organizations/$(orgId)/conversations/$(convId)).data.members
            && (request.resource.data.diff(resource.data).affectedKeys().hasOnly(['status'])
              || request.resource.data.diff(resource.data).affectedKeys().hasOnly(['attachment'])
              || request.resource.data.diff(resource.data).affectedKeys().hasOnly(['reactions']));
          allow delete: if request.auth != null
            && request.auth.uid in get(/databases/$(database)/documents/organizations/$(orgId)/conversations/$(convId)).data.members;
        }
        match /typing/{typerId} {
          allow read, write: if request.auth != null
            && request.auth.uid in get(/databases/$(database)/documents/organizations/$(orgId)/conversations/$(convId)).data.members;
        }
      }

      // Reports: any org member can create; admins can read
      match /reports/{reportId} {
        allow create: if request.auth != null
          && exists(/databases/$(database)/documents/memberships/$(orgId + '_' + request.auth.uid))
          && get(/databases/$(database)/documents/memberships/$(orgId + '_' + request.auth.uid)).data.state == 'active';
        allow read: if request.auth != null
          && exists(/databases/$(database)/documents/memberships/$(orgId + '_' + request.auth.uid))
          && get(/databases/$(database)/documents/memberships/$(orgId + '_' + request.auth.uid)).data.state == 'active'
          && get(/databases/$(database)/documents/memberships/$(orgId + '_' + request.auth.uid)).data.role in ['owner', 'admin'];
        allow update, delete: if false;
      }

      // Channels: active org members (legacy)
      match /channels/{channelId} {
        allow read, create: if request.auth != null
          && exists(/databases/$(database)/documents/memberships/$(orgId + '_' + request.auth.uid))
          && get(/databases/$(database)/documents/memberships/$(orgId + '_' + request.auth.uid)).data.state == 'active';
        allow update, delete: if false;
        match /messages/{messageId} {
          allow read, create: if request.auth != null
            && exists(/databases/$(database)/documents/memberships/$(orgId + '_' + request.auth.uid))
            && get(/databases/$(database)/documents/memberships/$(orgId + '_' + request.auth.uid)).data.state == 'active';
          allow update, delete: if false;
        }
      }
    }

    // Memberships: create (new org owner or join request), read, update (approve/reject)
    match /memberships/{membershipId} {
      allow create: if request.auth != null && request.resource.data.userId == request.auth.uid;
      allow read, update: if request.auth != null;
      allow delete: if false;
    }

    // Organization invitations: create by org admin; read/update by invitee (pending);
    // Org admins can read their org's invitations (incl. rejected) to see who declined.
    match /organizationInvitations/{invitationId} {
      allow create: if request.auth != null;
      allow read, update: if request.auth != null
        && (resource.data.status == 'pending'
          || (resource.data.orgId != null
            && exists(/databases/$(database)/documents/memberships/$(resource.data.orgId + '_' + request.auth.uid))
            && get(/databases/$(database)/documents/memberships/$(resource.data.orgId + '_' + request.auth.uid)).data.state == 'active'
            && get(/databases/$(database)/documents/memberships/$(resource.data.orgId + '_' + request.auth.uid)).data.role in ['owner', 'admin']));
      allow delete: if false;
    }

    // Team invitations: create by team/org admin; read/update by invitee (pending)
    match /teamInvitations/{invitationId} {
      allow create: if request.auth != null;
      allow read, update: if request.auth != null
        && resource.data.status == 'pending';
      allow delete: if false;
    }
  }
}
