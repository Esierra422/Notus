rules_version = '2';
// Deploy with: firebase deploy --only firestore
// Or paste into Firebase Console → Firestore Database → Rules
service cloud.firestore {
  match /databases/{database}/documents {
    // Users: any authenticated user can read (for org/team member display); only owner can write
    match /users/{userId} {
      allow read: if request.auth != null;
      allow write: if request.auth != null && request.auth.uid == userId;
    }

    // Organizations: authenticated users can create (new org) and read (search, get)
    match /organizations/{orgId} {
      allow create, read: if request.auth != null;
      allow update, delete: if request.auth != null;

      // Teams: active org members only
      match /teams/{teamId} {
        allow read, create, update: if request.auth != null
          && exists(/databases/$(database)/documents/memberships/$(orgId + '_' + request.auth.uid))
          && get(/databases/$(database)/documents/memberships/$(orgId + '_' + request.auth.uid)).data.state == 'active';
      }

      // Team memberships: active org members
      match /teamMemberships/{tmId} {
        allow read, create, update: if request.auth != null
          && exists(/databases/$(database)/documents/memberships/$(orgId + '_' + request.auth.uid))
          && get(/databases/$(database)/documents/memberships/$(orgId + '_' + request.auth.uid)).data.state == 'active';
      }

      // Meetings: active org members
      match /meetings/{meetingId} {
        allow read, create, update: if request.auth != null
          && exists(/databases/$(database)/documents/memberships/$(orgId + '_' + request.auth.uid))
          && get(/databases/$(database)/documents/memberships/$(orgId + '_' + request.auth.uid)).data.state == 'active';
      }
    }

    // Memberships: create (new org owner or join request), read, update (approve/reject)
    match /memberships/{membershipId} {
      allow create: if request.auth != null && request.resource.data.userId == request.auth.uid;
      allow read, update: if request.auth != null;
      allow delete: if false;
    }

    // Organization invitations: create by org admin; read/update by invitee
    // Email matching is enforced client-side (inviteeEmail stored lowercase)
    match /organizationInvitations/{invitationId} {
      allow create: if request.auth != null;
      allow read, update: if request.auth != null && resource.data.status == 'pending';
      allow delete: if false;
    }
  }
}
